<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="assets/admin.css">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">

    <!-- Bootstrap JS and Popper.js (required for Bootstrap JavaScript plugins) -->
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.3/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Add this CSS in your <head> section for styling the event cards -->
    <!-- Add this CSS in your <head> section for styling the event cards -->
    <style>
        .event-card {
            width: 70%;
            margin: 20px auto;
        }
    
        .event-image {
            max-height: 300px;
            /* Set a maximum height for the event image */
            object-fit: cover;
            /* Ensure the image covers the container */
        }
    </style>
</head>


<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <a class="navbar-brand" href="#">CSEC ASTU</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav"
            aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav">
                <li class="nav-item">
                    <a class="nav-link" href="#" id="homeLink">Home</a>
                </li>
                <li class="nav-item active">
                    <a class="nav-link" id="membersLink" href="#">Members List </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" id="reportsLink">ReportsPP</a>
                </li>
            </ul>
        </div>
    </nav>

    <!-- Home Div -->
    <div class="container mt-5">

        <!-- Add New Post Button -->
        <button type="button" class="btn btn-primary mt-3" data-toggle="modal" data-target="#addPostModal" id="NewPostBtn" style="display: none;">
            Add New Post
        </button>
        
        <!-- Add Post Modal -->
        <div class="modal" id="addPostModal" tabindex="-1" role="dialog" aria-labelledby="addPostModalLabel" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="addPostModalLabel">Add New Post</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <!-- Form to input new post data -->
                        <form id="addPostForm" action="/api/events" method="POST">
                            <div class="form-group">
                                <label for="eventImage">Event Image</label>
                                <input type="file" class="form-control-file" name="event_image" accept="image/*" required>
                            </div>
                            <div class="form-group">
                                <label for="eventTitle">Event Title</label>
                                <input type="text" class="form-control" name="event_title" required>
                            </div>
                            <div class="form-group">
                                <label for="eventDescription">Event Description</label>
                                <textarea class="form-control" name="event_description" rows="3" required></textarea>
                            </div>
                            <button type="submit" class="btn btn-primary">Post</button>
                        </form>

                    </div>
                </div>
            </div>
        </div>

        <div class="row" id="post" style="display: none;">
            <div class="col-md-6">
                <!-- Event Image -->
                <h2 id="eventTitle">Event Titile</h2>
                <img id="eventImage" class="img-fluid" alt="Event Image">
            </div>
            <div class="col-md-6">
                <!-- Event Description -->
                <p id="eventDescription">Event Description</p>
            </div>
        </div>
    </div>

    <!---Memeber List Div--->
    <!-- Add Member Button -->
    <div class="container mt-4" id="addbtn" style="display: none;">
        <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#addMemberModal">
            Add Member
        </button>
    </div>


    <!-- Container to display members' data -->
    <div class="container mt-4" id="tableHead" style="display: none;">
        <table class="table" id="membersTable">
            <thead class="thead-dark">
                <!-- Table header with column names -->
                <tr>
                    <th> ID</th>
                    <th>User Name</th>
                    <th>Sex</th>
                    <th>Role</th>
                    <th>Status</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                <!-- Data will be populated here -->
            </tbody>
        </table>
    </div>

    <!-- Add Member Modal -->
    <div class="modal" id="addMemberModal" tabindex="-1" role="dialog" aria-labelledby="addMemberModalLabel"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addMemberModalLabel">Add Member</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <!-- Form for adding a new member -->
                    <form id="addMemberForm">
                        <div class="form-group">
                            <label for="newUserName">User Name</label>
                            <input type="text" class="form-control" id="newUserName" required>
                        </div>
                        <div class="form-group">
                            <label for="newUserPassword">User Password</label>
                            <input type="password" class="form-control" id="newUserPassword" required>
                        </div>
                        <div class="form-group">
                            <label for="newUserRole">User Role</label>
                            <input type="text" class="form-control" id="newUserRole" required>
                        </div>
                        <div class="form-group">
                            <label for="newUserSex">Sex</label>
                            <input type="text" class="form-control" id="newUserSex" required>
                        </div>

                        <button type="submit" class="btn btn-primary">Save</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <!------------------------------------------------------------------------------------>

    <!-- Reports Div -->
    <div class="container mt-5" id="reports" style="display:none;">
        <!-- User Sex Report -->
        <div class="row mt-4">
            <div class="col-md-6">
                <h3>User Sex Report</h3>
                <canvas id="userSexChart"></canvas>
            </div>
        </div>

        <!-- User Role Report -->
        <div class="row mt-4">
            <div class="col-md-6">
                <h3>User Role Report</h3>
                <canvas id="userRoleChart"></canvas>
            </div>
        </div>

        <!-- User Status Report -->
        <div class="row mt-4">
            <div class="col-md-6">
                <h3>User Status Report</h3>
                <canvas id="userStatusChart"></canvas>
            </div>
        </div>
    </div>
    <!------------------------------------------------------------------------------------>

    <!-- Bootstrap JS and Popper.js (required for Bootstrap JavaScript plugins) -->
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.3/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>

    <script>
         // Trigger the click event for the "Home" link when the page loads
            window.onload = function () {
                document.getElementById("homeLink").click();
            };        
        // Function to display user data in the membersTable
        function displayUserData(users) {
            var membersTable = document.getElementById("membersTable");
            var tbody = membersTable.getElementsByTagName("tbody")[0];

            // Clear previous content
            tbody.innerHTML = "";

            // Display user data
            users.forEach(function (user) {
                var row = tbody.insertRow();

                // Add cells with data
                row.insertCell(0).textContent = user.user_id;
                row.insertCell(1).textContent = user.user_name;
                row.insertCell(2).textContent = user.user_sex;
                row.insertCell(3).textContent = user.user_role;
                row.insertCell(4).textContent = user.user_status;


                // New cell for buttons
                var actionCell = row.insertCell(5);

                // Add buttons for each row
                var editButton = document.createElement("button");
                editButton.textContent = "Edit Role";
                editButton.className = "admin-btn";
                editButton.addEventListener("click", function () {
                    editUser(user.user_id, user.user_role);
                });
                actionCell.appendChild(editButton);

                var deleteButton = document.createElement("button");
                deleteButton.textContent = "Delete";
                deleteButton.className = "admin-btn";
                deleteButton.addEventListener("click", function () {
                    deleteUser(user.user_id);
                });
                actionCell.appendChild(deleteButton);
            });
        }
        //=================== Edit user's Role=================
        // Function to handle editing a user
        function editUser(userId, currentRole) {
            // Prompt the user for the new role
            var newRole = prompt("Enter the new role for the user:", currentRole);

            if (newRole !== null) {
                // Send an AJAX request to update the user's role in the database
                var xhr = new XMLHttpRequest();
                xhr.open("PUT", "/admin/edit-user/" + userId + "/" + newRole, true);


                xhr.onreadystatechange = function () {
                    if (xhr.readyState === 4 && xhr.status === 200) {
                        // Refresh the member list after editing
                        fetchMemberData();
                    }
                };

                xhr.send();
            }
        }

        //===================================================

        //==========Deletion of an member===================
        // Function to handle deleting a user
            function deleteUser(userId) {
                // Fetch user data for confirmation
                var xhr = new XMLHttpRequest();
                xhr.open("DELETE", "/admin/delete-user/" + userId, true);

                xhr.onreadystatechange = function () {
                    if (xhr.readyState === 4) {
                        if (xhr.status === 200) {
                            var confirmationData = JSON.parse(xhr.responseText);

                            // Open a modal for confirmation
                            var confirmDelete = confirm("Are you sure you want to delete this user?\n\n" +
                                "User ID: " + confirmationData.user.user_id + "\n" +
                                "User Name: " + confirmationData.user.user_name);

                            if (confirmDelete) {
                                // Send a DELETE request to confirm deletion
                                var confirmDeleteXhr = new XMLHttpRequest();
                                confirmDeleteXhr.open("DELETE", "/admin/delete-user/" + userId + "/confirm", true);

                                confirmDeleteXhr.onreadystatechange = function () {
                                    if (confirmDeleteXhr.readyState === 4 && confirmDeleteXhr.status === 200) {
                                        // Refresh the member list after deletion
                                        fetchMemberData();
                                    }
                                };

                                confirmDeleteXhr.send();
                            }
                        }
                    }
                };

                xhr.send();
            }

        //=================================================

        // Function to fetch members' data from the server
        function fetchMemberData() {
            var xhr = new XMLHttpRequest();
            xhr.open("GET", "/admin/members", true);

            xhr.onreadystatechange = function () {
                if (xhr.readyState === 4 && xhr.status === 200) {
                    var users = JSON.parse(xhr.responseText);
                    displayUserData(users);
                }
            };

            xhr.send();
        }



        // Event listener for the "Members" link
        document.getElementById("membersLink").addEventListener("click", function () {
            var addbtn = document.getElementById("addbtn");
            var tableHead = document.getElementById("tableHead");
            addbtn.style.display = 'block';
            tableHead.style.display = 'block';
            // Fetch members' data from the server using AJAX
            fetchMemberData();
        });

        //==================Add memebers section=============
        function handleAddMemberForm(event) {
                event.preventDefault();

                // Get form data
                var newUserName = document.getElementById("newUserName").value;
                var newUserPassword = document.getElementById("newUserPassword").value;
                var newUserRole = document.getElementById("newUserRole").value;
                var newUserSex = document.getElementById("newUserSex").value; // New line

                // Log the values before sending the AJAX request
                console.log("New User Name:", newUserName);
                console.log("New User Password:", newUserPassword);
                console.log("New User Role:", newUserRole);
                console.log("New User Sex:", newUserSex); // New line

                // Send an AJAX request to add a new user
                var xhr = new XMLHttpRequest();
                xhr.open("POST", "/admin/add-user", true);
                xhr.setRequestHeader("Content-Type", "application/json");

                xhr.onreadystatechange = function () {
                    if (xhr.readyState === 4) {
                        if (xhr.status === 200) {
                            // Refresh the member list after adding a new member
                            fetchMemberData();
                            $('#addMemberModal').modal('hide'); // Hide the modal
                        } else {
                            // Handle the error case
                            console.error("Error adding a new member:", xhr.status, xhr.statusText);
                        }
                    }
                };

                // Convert data to JSON and send
                var data = JSON.stringify({
                    user_name: newUserName,
                    user_pass: newUserPassword,
                    user_role: newUserRole,
                    user_sex: newUserSex // New line
                });
                xhr.send(data);
            }


        // Attach the event listener to the form
        document.getElementById("addMemberForm").addEventListener("submit", handleAddMemberForm);
        //=====================================================

        //===================Event Things=============
        // Event listener for the "Home" link
            document.getElementById("homeLink").addEventListener("click", function () {
                var NewPostBtn = document.getElementById("NewPostBtn");
                var post = document.getElementById("post");
                NewPostBtn.style.display = 'block';
                post.style.display = 'block';

                // Fetch events from the server using AJAX
                fetch('/api/events2')
                    .then(response => response.json())
                    .then(events => {
                        // Display events on the page
                        displayEvents(events);
                    })
                    .catch(error => {
                        console.error('Error fetching events:', error);
                        // Handle errors as needed
                    });
            });

            // Function to display events on the page
                function displayEvents(events) {
                    var post = document.getElementById("post");
                    var eventContainer = document.createElement("div");

                    // Clear previous content
                    post.innerHTML = "";

                    // Display each event in a Bootstrap card
                    events.forEach(function (event) {
                        var eventCard = document.createElement("div");
                        eventCard.className = "card event-card";
                        eventCard.innerHTML = `
                    <div class="card-body">
                        <h5 class="card-title">${event.event_title}</h5>
                    </div>
                    <img src="/assets/images/computer_science_and_engineering_club_cover.jpeg" class="card-img-top event-image" alt="Event Image">

                    <div class="card-body">
                        <p class="card-text">${event.event_description}</p>
                    </div>
                `;

                        // Append the eventCard to the eventContainer
                        eventContainer.appendChild(eventCard);
                    });

                    // Append the eventContainer to the post
                    post.appendChild(eventContainer);
                }

        
        document.getElementById('addEventForm').addEventListener('submit', function (event) {
                event.preventDefault();

                // Get form values
                const formData = new FormData(this);

                // Send a POST request to the server
                fetch('/api/events', {
                    method: 'POST',
                    body: formData,
                })
                    .then(response => response.json())
                    .then(data => {
                        // Handle the response as needed
                        console.log('Response from server:', data);
                        // You may want to update the UI or take other actions
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        // Handle errors as needed
                    });
            });

        //==========================================

        //===================Reports===================

        // Function to display reports using colored bar graphs
            function displayReports(userData) {
                // User Sex Chart
                var userSexCtx = document.getElementById('userSexChart').getContext('2d');
                var userSexChart = new Chart(userSexCtx, {
                    type: 'bar',
                    data: {
                        labels: ['Female', 'Male'],
                        datasets: [{
                            label: 'User Sex',
                            data: [
                                userData.filter(user => user.user_sex === 'F').length,
                                userData.filter(user => user.user_sex === 'M').length
                            ],
                            backgroundColor: ['#FF6384', '#36A2EB']
                        }]
                    }
                });

                // User Role Chart
                var userRoleCtx = document.getElementById('userRoleChart').getContext('2d');
                var userRoleChart = new Chart(userRoleCtx, {
                    type: 'bar',
                    data: {
                        labels: ['Admin', 'Member'],
                        datasets: [{
                            label: 'User Role',
                            data: [
                                userData.filter(user => user.user_role === 'Admin').length,
                                userData.filter(user => user.user_role === 'Member').length
                            ],
                            backgroundColor: ['#FFCE56', '#4CAF50']
                        }]
                    }
                });

                // User Status Chart
                var userStatusCtx = document.getElementById('userStatusChart').getContext('2d');
                var userStatusChart = new Chart(userStatusCtx, {
                    type: 'bar',
                    data: {
                        labels: ['Active', 'Inactive'],
                        datasets: [{
                            label: 'User Status',
                            data: [
                                userData.filter(user => user.user_status === 'Active').length,
                                userData.filter(user => user.user_status === 'Inactive').length
                            ],
                            backgroundColor: ['#36A2EB', '#FF6384']
                        }]
                    }
                });
            }

            // Event listener for the "Reports" link
            document.getElementById("reportsLink").addEventListener("click", function () {
                var reports = document.getElementById("reports");
                reports.style.display = 'block';

                // // Fetch user data for generating reports
                // var xhr = new XMLHttpRequest();
                // xhr.open("GET", "/admin/reports", true);

                // xhr.onreadystatechange = function () {
                //     if (xhr.readyState === 4 && xhr.status === 200) {
                //         var userData = JSON.parse(xhr.responseText);
                //         displayReports(userData);
                //     }
                // };

                // xhr.send();
            });








        // document.getElementById("reportsLink").addEventListener("click", function () {
        //     var reports = document.getElementById("reports");
        //     reports.style.display = 'block';
        
        //     console.log("Reports link clicked");
        //     fetchReports(); // Ensure fetchReports function is correctly defined
        // });

        //     // Add the fetchReports function
        //     function fetchReports() {
        //         // Fetch reports from the server using AJAX
        //         fetch('/admin/reports')
        //             .then(response => response.json())
        //             .then(reports => {
        //                 // Log the fetched reports to the console
        //                 console.log('Fetched reports:', reports);

        //                 // Process the reports data as needed
        //                 displayReports(reports);
        //             })
        //             .catch(error => {
        //                 console.error('Error fetching reports:', error);
        //                 // Handle errors as needed
        //             });
        //     }

        //     // Add the displayReports function
        //     function displayReports(reports) {
        //         // Log the reports data to the console
        //         console.log('Displaying reports:', reports);
        //         var reportsContainer = document.getElementById("reportsContainer");
        //         reportsContainer.innerHTML = "";

        //         // Iterate through the reports data and create elements
        //         reportsData.forEach(function (report) {
        //             var reportElement = document.createElement("div");
        //             reportElement.innerHTML = `
        //         <p>${report.user_sex}: ${report.count} users</p>
        //         <p>${report.user_role}: ${report.count} users</p>
        //         <p>${report.user_status}: ${report.count} users</p>
        //     `;

        //             reportsContainer.appendChild(reportElement);
        //         });
        //     }

        //===============================================

    </script>
</body>

</html>