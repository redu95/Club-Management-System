<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="assets/admin.css">
    
    <!-- Chart.js CSS (if needed) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/chart.js">  

  
   <!-- Add this CSS in your <head> section f in your <head> section for styling the event cards -->
    <style>
        .event-card {
            width: 70%;
            margin: 20px auto;
        }
    
        .event-image {
            max-height: 300px;
            /* Set a maximum height for the event image */
            object-fit: cover;
            /* Ensure the image covers the container */
        }
        .page-content {
            display: none;
        }

        .active {
            display: block;
        }
    </style>
</head>


<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <a class="navbar-brand" href="#">CSEC ASTU</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav"
            aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav">
                <li class="nav-item">
                    <a class="nav-link" href="#" id="homeLink">Home</a>
                </li>
                <li class="nav-item active">
                    <a class="nav-link" id="membersLink" href="#">Members List </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" id="reportsLink">Reports</a>
                </li>
                <li class="nav-item dropdown ml-auto">
                    <a class="nav-link" href="#" id="profileDropdown"> My Profile</a>
                </li>
            </ul>
        </div>
    </nav>

    <div class="container mt-4" id="variablePage">
        <!-- Content will be dynamically loaded here based on menu selection -->
    </div>

    <!-- Home Page Content -->
    <div class="container mt-5 page-content" id="homeContent">
        <div class="container mt-5">
        
            <!-- Add New Post Button -->
            <button type="button" class="btn btn-primary mt-3" data-toggle="modal" data-target="#addPostModal" id="NewPostBtn"
                style="display: none;">
                Post New Event +
            </button>
        
            <!-- Add Post Modal -->
            <div class="modal" id="addPostModal" tabindex="-1" role="dialog" aria-labelledby="addPostModalLabel"
                aria-hidden="true">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="addPostModalLabel">Add New Post</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <!-- Form to input new post data -->
                            <form id="addPostForm" enctype="multipart/form-data" action="/api/events" method="POST">
                                <div class="form-group">
                                    <label for="eventImage">Event Image</label>
                                    <input type="file" class="form-control-file" name="event_image" accept="image/*" required>
                                </div>
                                <div class="form-group">
                                    <label for="eventTitle">Event Title</label>
                                    <input type="text" class="form-control" name="event_title" required>
                                </div>
                                <div class="form-group">
                                    <label for="eventDescription">Event Description</label>
                                    <textarea class="form-control" name="event_description" rows="3" required></textarea>
                                </div>
                                <button type="submit" class="btn btn-primary">Post</button>
                            </form>
        
                        </div>
                    </div>
                </div>
            </div>
        
            <div class="row" id="post" style="display: none;">
                <div class="col-md-6">
                    <!-- Event Image -->
                    <h2 id="eventTitle">Event Titile</h2>
                    <img id="eventImage" class="img-fluid" alt="Event Image">
                </div>
                <div class="col-md-6">
                    <!-- Event Description -->
                    <p id="eventDescription">Event Description</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Members Page Content -->
    <div class="container mt-5 page-content" id="membersContent">
        <!-- Add Member Button -->
        <div class="container mt-4" id="addbtn" style="display: none;">
            <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#addMemberModal">
                Add Member
            </button>
        </div>

        <!-- Container to display members' data -->
        <div class="container mt-4" id="tableHead" style="display: none;">
            <table class="table" id="membersTable">
                <thead class="thead-dark">
                    <!-- Table header with column names -->
                    <tr>
                        <th> ID</th>
                        <th>User Name</th>
                        <th>Sex</th>
                        <th>Role</th>
                        <th>Status</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Data will be populated here -->
                </tbody>
            </table>
        </div>
        
        <!-- Add Member Modal -->
        <div class="modal" id="addMemberModal" tabindex="-1" role="dialog" aria-labelledby="addMemberModalLabel"
            aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="addMemberModalLabel">Add Member</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <!-- Form for adding a new member -->
                        <form id="addMemberForm">
                            <div class="form-group">
                                <label for="newUserName">User Name</label>
                                <input type="text" class="form-control" id="newUserName" required>
                            </div>
                            <div class="form-group">
                                <label for="newUserPassword">User Password</label>
                                <input type="password" class="form-control" id="newUserPassword" required>
                            </div>
                            <div class="form-group">
                                <label for="newUserRole">User Role</label>
                                <input type="text" class="form-control" id="newUserRole" required>
                            </div>
                            <div class="form-group">
                                <label for="newUserSex">Sex</label>
                                <input type="text" class="form-control" id="newUserSex" required>
                            </div>
        
                            <button type="submit" class="btn btn-primary">Save</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Edit User Modal -->
        <div class="modal" id="editUserModal" tabindex="-1" role="dialog" aria-labelledby="editUserModalLabel"
            aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="editUserModalLabel">Edit User</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <!-- Form to edit user data -->
                        <form id="editUserForm">
                            <div class="form-group">
                                <label for="newUserRole">New Role</label>
                                <input type="text" class="form-control" id="editRoleInput" required>
                            </div>
                            <div class="form-group">
                                <label for="newUserStatus">New Status</label>
                                <input type="text" class="form-control" id="editStatusInput" required>
                            </div>
                            <button type="submit" class="btn btn-primary" id="saveChangesBtn">Save Changes</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

    </div>
    
    <!-- Reports Page Content -->
    <div class="container mt-5 page-content" id="reportsContent">
        <!-- Reports Div -->
        <div class="container mt-5" id="reports" style="display:none;">
            <!-- User Sex Report -->
            <div class="row mt-4">
                <div class="col-md-6">
                    <h3>User Sex Report</h3>
                    <canvas id="userSexChart"></canvas>
                </div>
            </div>
        
            <!-- User Role Report -->
            <div class="row mt-4">
                <div class="col-md-6">
                    <h3>User Role Report</h3>
                    <canvas id="userRoleChart"></canvas>
                </div>
            </div>
        
            <!-- User Status Report -->
            <div class="row mt-4">
                <div class="col-md-6">
                    <h3>User Status Report</h3>
                    <canvas id="userStatusChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="container mt-5 page-content" id="profileContent">
        <!-- Add a new div for the profile information -->
        <div class="container mt-4" id="profileInfo" style="display: none;">
            <div class="col-md-6">
                <!-- Profile Information -->
                <h2 id="profileTitle">My Profile</h2>
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title" id="username">Username</h5>
                        <p class="card-text" id="userSex">Sex: </p>
                        <p class="card-text" id="userRole">Role: </p>
                        <p class="card-text" id="userStatus">Status: </p>
                        <button class="btn btn-primary" id="editProfileBtn">Edit Profile</button>
                        <button class="btn btn-primary" id="changePasswordBtn">Change Password</button>
                    </div>
                </div>
            </div>
        </div>
        <!-- Edit Profile Modal -->
        <div class="modal fade" id="editProfileModal" tabindex="-1" role="dialog" aria-labelledby="editProfileModalLabel"
            aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="editProfileModalLabel">Edit Profile</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <form id="editProfileForm">
                            <div class="form-group">
                                <label for="editUsername">Username</label>
                                <input type="text" class="form-control" id="editUsername" required>
                            </div>
                            <div class="form-group">
                                <label for="editUserSex">Sex</label>
                                <select class="form-control" id="editUserSex" required>
                                    <option value="Male">M</option>
                                    <option value="Female">F</option>
                                </select>
                            </div>
                            <button type="submit" class="btn btn-primary" id="saveChangesEditProfile">Save Changes</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Change Password Modal -->
        <div class="modal fade" id="changePasswordModal" tabindex="-1" role="dialog" aria-labelledby="changePasswordModalLabel"
            aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="changePasswordModalLabel">Change Password</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <form id="changePasswordForm">
                            <div class="form-group">
                                <label for="oldPassword">Old Password</label>
                                <input type="password" class="form-control" id="oldPassword" required>
                            </div>
                            <div class="form-group">
                                <label for="newPassword">New Password</label>
                                <input type="password" class="form-control" id="newPassword" required>
                            </div>
                            <button type="submit" class="btn btn-primary" id="saveChangesChangePassword">Save Changes</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

   
    
    <!------------------------------------------------------------------------------------>

    <!-- Bootstrap JS and Popper.js (required for Bootstrap JavaScript plugins) -->
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.3/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>

    <script>
        // Show the home page by default
            showHomePage();
        // Function to hide all pages
        function hideAllPages() {
            var pages = document.querySelectorAll('.page-content');
            pages.forEach(function (page) {
                page.classList.remove("active");
            });
        }

        
        // Function to show content for the home page
        function showHomePage() {
            hideAllPages();
            document.getElementById("homeContent").classList.add("active");
            homePage();
        }

        // Function to show content for the members page
        function showMembersPage() {
            hideAllPages();
            document.getElementById("membersContent").classList.add("active");
        }

        // Function to show content for the reports page
        function showReportsPage() {
            hideAllPages();
            document.getElementById("reportsContent").classList.add("active");
        }
        function showProfilePage(){
            hideAllPages();
            document.getElementById("profileContent").classList.add("active");
        }

        // Function to display user data in the membersTable
        function displayUserData(users) {
            var membersTable = document.getElementById("membersTable");
            var tbody = membersTable.getElementsByTagName("tbody")[0];

            // Clear previous content
            tbody.innerHTML = "";

            // Display user data
            users.forEach(function (user) {
                var row = tbody.insertRow();

                // Add cells with data
                row.insertCell(0).textContent = user.user_id;
                row.insertCell(1).textContent = user.user_name;
                row.insertCell(2).textContent = user.user_sex;
                row.insertCell(3).textContent = user.user_role;
                row.insertCell(4).textContent = user.user_status;


                // New cell for buttons
                var actionCell = row.insertCell(5);

                // Add buttons for each row
                var editButton = document.createElement("button");
                editButton.textContent = "Edit";
                editButton.className = "admin-btn";
                editButton.addEventListener("click", function () {
                   showEditModal(user.user_id, user.user_role, user.user_status);
                });
                actionCell.appendChild(editButton);

                var deleteButton = document.createElement("button");
                deleteButton.textContent = "Delete";
                deleteButton.className = "admin-btn";
                deleteButton.addEventListener("click", function () {
                    deleteUser(user.user_id);
                });
                actionCell.appendChild(deleteButton);
            });
        }
        //=================== Edit user's Role=================
        // Function to show the edit modal
            function showEditModal(userId, currentRole, currentStatus) {
                // Populate the modal with the current role and status
                document.getElementById("editUserModal").dataset.userId = userId;
                document.getElementById("editRoleInput").value = currentRole;
                document.getElementById("editStatusInput").value = currentStatus;

                // Show the modal
                $('#editUserModal').modal('show');
            }
        // Function to handle editing a user
            function editUser(userId, currentRole, currentStatus) {
                // Prompt the user for the new role and status
                var newRole = currentRole;
                var newStatus = currentStatus;
                
                

                if (newRole !== null && newStatus !== null) {
                    // Prepare the data to send in the request body
                    var data = {
                        userId: userId,
                        newRole: newRole,
                        newStatus: newStatus
                    };

                    // Send an AJAX request to update the user's role and status in the database
                    fetch("/admin/edit-user/" + userId, {
                        method: "PUT",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify(data)
                    })
                        .then(response => {
                            if (!response.ok) {
                                throw new Error("Network response was not ok");
                            }
                            // Refresh the member list after editing
                            fetchMemberData();
                        })
                        .catch(error => {
                            console.error("Error updating user role and status:", error);
                        });
                }
            }

            // Add an event listener to the "Save Changes" button in the edit modal
                document.getElementById("saveChangesBtn").addEventListener("click", function () {
                    // Retrieve values from the modal
                    var userId = document.getElementById("editUserModal").dataset.userId;
                    var currentRole = document.getElementById("editRoleInput").value;
                    var currentStatus = document.getElementById("editStatusInput").value;
                    editUser(userId, currentRole, currentStatus);
                });


        //===================================================

        //==========Deletion of an member===================
        // Function to handle deleting a user
            function deleteUser(userId) {
                // Fetch user data for confirmation
                var xhr = new XMLHttpRequest();
                xhr.open("DELETE", "/admin/delete-user/" + userId, true);

                xhr.onreadystatechange = function () {
                    if (xhr.readyState === 4) {
                        if (xhr.status === 200) {
                            var confirmationData = JSON.parse(xhr.responseText);

                            // Open a modal for confirmation
                            var confirmDelete = confirm("Are you sure you want to delete this user?\n\n" +
                                "User ID: " + confirmationData.user.user_id + "\n" +
                                "User Name: " + confirmationData.user.user_name);

                            if (confirmDelete) {
                                // Send a DELETE request to confirm deletion
                                var confirmDeleteXhr = new XMLHttpRequest();
                                confirmDeleteXhr.open("DELETE", "/admin/delete-user/" + userId + "/confirm", true);

                                confirmDeleteXhr.onreadystatechange = function () {
                                    if (confirmDeleteXhr.readyState === 4 && confirmDeleteXhr.status === 200) {
                                        // Refresh the member list after deletion
                                        fetchMemberData();
                                    }
                                };

                                confirmDeleteXhr.send();
                            }
                        }
                    }
                };

                xhr.send();
            }

        //=================================================

        // Function to fetch members' data from the server
        function fetchMemberData() {
            var xhr = new XMLHttpRequest();
            xhr.open("GET", "/admin/members", true);

            xhr.onreadystatechange = function () {
                if (xhr.readyState === 4 && xhr.status === 200) {
                    var users = JSON.parse(xhr.responseText);
                    displayUserData(users);
                }
            };

            xhr.send();
        }
        function membersPage(){
            var addbtn = document.getElementById("addbtn");
            var tableHead = document.getElementById("tableHead");
            addbtn.style.display = 'block';
            tableHead.style.display = 'block';
            // Fetch members' data from the server using AJAX
            fetchMemberData();
        }


        // Event listener for the "Members" link
        document.getElementById("membersLink").addEventListener("click", function () {
            showMembersPage();
            membersPage();
        });

        //==================Add memebers section=============
        function handleAddMemberForm(event) {
                event.preventDefault();

                // Get form data
                var newUserName = document.getElementById("newUserName").value;
                var newUserPassword = document.getElementById("newUserPassword").value;
                var newUserRole = document.getElementById("newUserRole").value;
                var newUserSex = document.getElementById("newUserSex").value; // New line

                // Log the values before sending the AJAX request
                console.log("New User Name:", newUserName);
                console.log("New User Password:", newUserPassword);
                console.log("New User Role:", newUserRole);
                console.log("New User Sex:", newUserSex); // New line

                // Send an AJAX request to add a new user
                var xhr = new XMLHttpRequest();
                xhr.open("POST", "/admin/add-user", true);
                xhr.setRequestHeader("Content-Type", "application/json");

                xhr.onreadystatechange = function () {
                    if (xhr.readyState === 4) {
                        if (xhr.status === 200) {
                            // Refresh the member list after adding a new member
                            fetchMemberData();
                            $('#addMemberModal').modal('hide'); // Hide the modal
                        } else {
                            // Handle the error case
                            console.error("Error adding a new member:", xhr.status, xhr.statusText);
                        }
                    }
                };

                // Convert data to JSON and send
                var data = JSON.stringify({
                    user_name: newUserName,
                    user_pass: newUserPassword,
                    user_role: newUserRole,
                    user_sex: newUserSex // New line
                });
                xhr.send(data);
            }


        // Attach the event listener to the form
        document.getElementById("addMemberForm").addEventListener("submit", handleAddMemberForm);
        //=====================================================

        //===================Event Things=============
        function homePage(){
            var NewPostBtn = document.getElementById("NewPostBtn");
            var post = document.getElementById("post");
            NewPostBtn.style.display = 'block';
            post.style.display = 'block';

            // Fetch events from the server using AJAX
            fetch('/api/events2')
                .then(response => response.json())
                .then(events => {
                    // Display events on the page
                    displayEvents(events);
                })
                .catch(error => {
                    console.error('Error fetching events:', error);
                    // Handle errors as needed
                });
        }
        // Event listener for the "Home" link
            document.getElementById("homeLink").addEventListener("click", function () {
               showHomePage();
            });

            // Function to display events on the page
                function displayEvents(events) {
                    var post = document.getElementById("post");
                    var eventContainer = document.createElement("div");
                    
                    // Clear previous content
                    post.innerHTML = "";

                    // Display each event in a Bootstrap card
                    events.forEach(function (event) {
                        var eventCard = document.createElement("div");
                        eventCard.className = "card event-card";
                        eventCard.innerHTML = `
            <div class="card-body">
                <h5 class="card-title">${event.event_title}</h5>
            </div>`;

                        if (event.event_image !== null) {
                            try {
                                const base64Image = event.event_image.toString('base64');
                                eventCard.innerHTML += `<img src="data:image/jpeg;base64,${base64Image}" class="card-img-top event-image" alt="Event Image">`;
                            } catch (error) {
                                console.error('Error converting image to base64:', error);
                                // Handle errors, e.g., log the error or display a placeholder image
                                eventCard.innerHTML += `<img src="path/to/placeholder-image.jpg" class="card-img-top event-image" alt="Event Image Placeholder">`;
                            }
                        }

                        eventCard.innerHTML += `
            <div class="card-body">
                <p class="card-text">${event.event_description}</p>
            </div>`;

                        // Append the eventCard to the eventContainer
                        eventContainer.appendChild(eventCard);
                    });

                    // Append the eventContainer to the post
                    post.appendChild(eventContainer);
                }

        
        document.getElementById('addEventForm').addEventListener('submit', function (event) {
                event.preventDefault();

                // Get form values
                const formData = new FormData(this);

                // Send a POST request to the server
                fetch('/api/events', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        // Make sure to include the Content-Type header
                        // with the value 'multipart/form-data'
                        'Content-Type': 'multipart/form-data',
                    },
                })
                    .then(response => response.json())
                    .then(data => {
                        // Handle the response as needed
                        console.log('Response from server:', data);
                        // You may want to update the UI or take other actions
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        // Handle errors as needed
                    });
            });

        //==========================================

        //===================Reports===================
            function reportsPage(){
                var reports = document.getElementById("reports");
                reports.style.display = 'block';

                // Fetch reports data for generating charts
                var xhr = new XMLHttpRequest();
                xhr.open("GET", "/admin/reports", true);

                xhr.onreadystatechange = function () {
                    if (xhr.readyState === 4 && xhr.status === 200) {
                        var reportData = JSON.parse(xhr.responseText);
                        displayReports(reportData);
                    }
                };

                xhr.send();
            }
        // Event listener for the "Reports" link
            document.getElementById("reportsLink").addEventListener("click", function () {
                showReportsPage();
                reportsPage();
            });
         function displayReports(reportData) {
                // User Sex Chart
                var userSexCtx = document.getElementById('userSexChart').getContext('2d');
                var userSexChart = new Chart(userSexCtx, {
                    type: 'bar',
                    data: {
                        labels: ['Female', 'Male'],
                        datasets: [{
                            label: 'User Sex',
                            data: [
                                reportData.find(item => item.user_sex === 'F')?.count || 0,
                                reportData.find(item => item.user_sex === 'M')?.count || 0
                            ],
                            backgroundColor: ['#FF6384', '#36A2EB']
                        }]
                    }
                });

                // User Role Chart
                var userRoleCtx = document.getElementById('userRoleChart').getContext('2d');
                var userRoleChart = new Chart(userRoleCtx, {
                    type: 'bar',
                    data: {
                        labels: ['Admin', 'Member'],
                        datasets: [{
                            label: 'User Role',
                            data: [
                                reportData.find(item => item.user_role === 'Admin')?.count || 0,
                                reportData.find(item => item.user_role === 'Member')?.count || 0
                            ],
                            backgroundColor: ['#FFCE56', '#4CAF50']
                        }]
                    }
                });

                // User Status Chart
                var userStatusCtx = document.getElementById('userStatusChart').getContext('2d');
                var userStatusChart = new Chart(userStatusCtx, {
                    type: 'bar',
                    data: {
                        labels: ['Active', 'Inactive'],
                        datasets: [{
                            label: 'User Status',
                            data: [
                                reportData.find(item => item.user_status === 'Active')?.count || 0,
                                reportData.find(item => item.user_status === 'Inactive')?.count || 0
                            ],
                            backgroundColor: ['#36A2EB', '#FF6384']
                        }]
                    }
                });
            }
        //===============================================
        //========================= MY PROFILE =========================
            // Event listener for "My Profile" link
            document.getElementById("profileDropdown").addEventListener("click", function () {
                showProfilePage(); 
                profilePage();
            });
            function profilePage(){
                var pro =document.getElementById("profileInfo");
                pro.style.display = 'block';
                
                // Fetch profile information from the server using AJAX
                fetch('/api/profileInfo2', { credentials: 'include' })
                    .then(response => response.json())
                    .then(profileInfo => {
                        // Display profile information on the page
                        displayProfileInfo(profileInfo);
                    })
                    .catch(error => {
                        console.error('Error fetching profile information:', error);
                        // Handle errors as needed
                    });

            }

            // Function to display profile information on the page
            function displayProfileInfo(profileInfo) {
                document.getElementById("username").innerText = 'Username: ' + profileInfo.user_name;
                document.getElementById("userSex").innerText = 'Sex: ' + profileInfo.user_sex;
                document.getElementById("userRole").innerText = 'Role: ' + profileInfo.user_role;
                document.getElementById("userStatus").innerText = 'Status: ' + profileInfo.user_status;
            }

            //==========================Edit Profile===================================


            // Event listener for "Edit Profile" link
            document.getElementById("editProfileBtn").addEventListener("click", function () {
                // Fetch profile information from the server using AJAX
                fetch('/api/profileInfo2', { credentials: 'include' })
                    .then(response => response.json())
                    .then(profileInfo => {
                        // Populate the modal with current profile information
                        document.getElementById("editUsername").value = profileInfo.user_name;
                        document.getElementById("editUserSex").value = profileInfo.user_sex;

                        // Show the "Edit Profile" modal
                        $('#editProfileModal').modal('show');
                    })
                    .catch(error => {
                        console.error('Error fetching profile information:', error);
                        // Handle errors as needed
                    });
            });

            document.getElementById("saveChangesEditProfile").addEventListener("click", function () {
                // Extract updated username and usersex from the form
                const newUsername = document.getElementById("editUsername").value;
                const newUserSex = document.getElementById("editUserSex").value;

                // Make the HTTP POST request to update profile information
                fetch('/api/editProfile', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        newUsername,
                        newUserSex,
                    }),
                    credentials: 'include', // Include credentials for session
                })
                    .then(response => response.text())
                    .then(data => {
                        console.log(data); // Log the response
                        // Optionally, you can close the modal
                        $('#editProfileModal').modal('hide');
                        // Reload the page or update the displayed information as needed
                    })
                    .catch(error => {
                        console.error('Error updating profile information:', error);
                        // Handle errors as needed
                    });
            });

            //==================Change password area==================================
            // Event listener for the "Change Password" link
            document.getElementById("changePasswordBtn").addEventListener("click", function () {
                // Show the "Change Password" modal
                $('#changePasswordModal').modal('show');
            });

            // Updated event listener for the "Save Changes" button in the "Change Password" modal
            document.getElementById("saveChangesChangePassword").addEventListener("click", function () {
                // Extract old password and new password from the form
                const oldPassword = document.getElementById("oldPassword").value;
                const newPassword = document.getElementById("newPassword").value;

                // Make the HTTP POST request to change the password
                fetch('/api/changePassword', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        oldPassword,
                        newPassword,
                    }),
                    credentials: 'include', // Include credentials for session
                })
                    .then(response => response.text())
                    .then(data => {
                        console.log(data); // Log the response
                        // Optionally, you can close the modal
                        $('#changePasswordModal').modal('hide');

                        // Reload the page or update the displayed information as needed
                    })
                    .catch(error => {
                        console.error('Error changing password:', error);
                        // Handle errors as needed
                    });
            });
            //=============================================================
    </script>
</body>

</html> to update')
                            }
                        }
                    );
                } else {
                    res.status(404).send('User not found');
                }
            }
        );
    } else {
        res.status(401).json({ error: 'Unauthor